# Day 3 ‚Äî Matching Algorithms & Real-Time Dispatch Logic

## üéØ Objective
Design and implement the driver‚Äìrider matching system for a ride-hailing platform that:
- Selects the most optimal driver in terms of ETA, proximity, and availability.
- Supports high-volume, low-latency matching during surge demand.
- Integrates with PostgreSQL + PostGIS for spatial queries.

---

## üß© Core Components

### 1. Matching Flow
1. **Rider requests trip** ‚Üí stored in `trips` with `status='requested'`.
2. **Search for nearby drivers** using PostGIS spatial queries within a defined radius.
3. **Rank drivers** based on:
   - Distance to pickup location.
   - Estimated Time of Arrival (ETA) using traffic data.
   - Driver rating and acceptance rate.
4. **Lock driver** for assignment:
   - Prevents multiple trips being assigned at once.
   - Implemented with `FOR UPDATE SKIP LOCKED`.
5. **Push trip request** to driver in real time via WebSocket or Firebase Cloud Messaging.
6. **Timeout + retry** logic if driver does not accept.

---

## üìç Example Matching Query
```sql
WITH nearby AS (
  SELECT driver_id,
         ST_Distance(location, ST_SetSRID(ST_MakePoint($1, $2), 4326)) AS distance
  FROM driver_locations
  WHERE ST_DWithin(location, ST_SetSRID(ST_MakePoint($1, $2), 4326), $3)
  ORDER BY distance ASC
  LIMIT 10
)
SELECT d.driver_id, d.distance, u.rating
FROM nearby d
JOIN users u ON u.user_id = d.driver_id
ORDER BY u.rating DESC, d.distance ASC;
```

## ‚ö° Optimization Tactics

| Challenge                  | Strategy |
|----------------------------|----------|
| High query load            | Use **materialized views** or in-memory caches for available drivers. |
| Surges in requests         | Batch match riders and drivers in **1‚Äì2s windows**. |
| Cold start for new drivers | Preload with predictive positioning based on demand heatmaps. |
| Lock contention            | Use **row-level locks** + `SKIP LOCKED` for concurrency. |

---

## üîÑ Real-Time Considerations

- **Location update frequency:** 3‚Äì5 seconds for active drivers.  
- **Dispatch SLA:** Match within 1‚Äì2 seconds from rider request.  
- **WebSocket scaling:** Shard by geographic region or user ID.  
- **Fallback:** REST polling if WebSocket is unavailable.  

---

## üîê Security

- Only authenticated drivers can receive trip offers.  
- Match events stored in `trip_events` for auditing.  
- Location queries anonymized for non-matching purposes.  

---

## üöó Relevance to Bimride

| Feature                     | Matching Role |
|-----------------------------|---------------|
| Fast driver assignment      | Reduces rider wait times. |
| Surge demand handling       | Maximizes fleet utilization. |
| Driver quality prioritization| Improves rider satisfaction. |
| Geographic sharding         | Supports nationwide scaling. |

---

## üìå Deliverables for Day 3

‚úÖ Implemented driver search + ranking query.  
‚úÖ Designed concurrency-safe locking strategy.  
‚úÖ Configured WebSocket + fallback polling.  
‚úÖ Documented performance targets for matching latency.  
‚úÖ Outlined security rules for dispatch events.  
